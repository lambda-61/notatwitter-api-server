#+property: header-args:elixir :dir "."
#+property: header-args:diff :results silent :dir "."
#+BEGIN_SRC emacs-lisp
(defun org-babel-execute:diff (body params)
  (let* ((tmp (org-babel-temp-file "patch-"))
         (cmd (concat "git apply " tmp))
         (file-a (assoc-default :file-a params))
         (file-b (assoc-default :file-b params)))
    (with-temp-file tmp
      (insert (concat
        "--- " file-a "\n"
        "+++ " file-b "\n"
        body)))
    (with-temp-buffer
      (async-shell-command cmd (current-buffer)))))
#+END_SRC
#+BEGIN_SRC emacs-lisp
(defun ob-elixir-ensure-session (session params)
  (let ((name (format "*elixir-%s*" session)))
    (unless (and (get-process name)
                 (process-live-p (get-process name)))
      (with-current-buffer (get-buffer-create name)
        (setq-local process-environment (cons "TERM=vt100" process-environment))
        (apply #'start-process name name "iex"
               (append (when (assoc :script params)
                         (list "-S" (assoc-default :script params)))
                       (when (assoc :sname params)
                         (list "--sname" (assoc-default :sname params)))
                       (when (assoc :name params)
                         (list "--name" (assoc-default :name params)))
                       (when (assoc :cookie params)
                         (list "--cookie" (assoc-default :cookie params)))
                       (when (assoc :remsh params)
                         (list "--remsh" (assoc-default :remsh params))))))
      (set-process-filter (get-process name) 'ob-elixir-process-filter)
      (ob-elixir-eval-in-repl session "IEx.configure(colors: [enabled: false])"))))
#+END_SRC
* –ü–ª–∞–Ω
** –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ
*** –ø–ª—é—Å—ã

–≠–ª–∏–∫—Å–∏—Ä -- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —è–∑—ã–∫. –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç
–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ beam, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç erlang. –¢–∞–∫ –∂–µ –∫–∞–∫
clojure —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ jvm.

–í —ç–ª–∏–∫—Å–∏—Ä–µ –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ -- –º–æ–¥—É–ª—å, –≤ –Ω–∏—Ö –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è
—Ñ—É–Ω–∫—Ü–∏–∏. –≠–ª–∏–∫—Å–∏—Ä, –∫–∞–∫ —Ñ–ø-—è–∑—ã–∫, —Ä–∞—Å–ø–æ–ª–æ–≥–∞–µ—Ç –∫ —Ç–æ–º—É, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É
–≤ —á–∏—Å—Ç—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö –∏ –≤—ã—Ä–∞–∂–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
–∏ —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å –Ω–∏–º–∏ –≤–º–µ—Å—Ç–æ –∫–ª–∞—Å—Å–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–≤. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º,
–º—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏, –∞ –Ω–µ —Å –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º.

–¢–∞–∫ –∂–µ, –≤ —ç–ª–∏–∫—Å–∏—Ä–µ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω-–º–∞—Ç—á–∏–Ω–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
—Å –≤–µ—Ç–≤–ª–µ–Ω–∏–µ–º –∏ –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –≤–Ω–æ—Å–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.

*** —Ñ–µ–Ω–∏–∫—Å

–î–ª—è —ç–ª–∏–∫—Å–∏—Ä–∞ –µ—Å—Ç—å –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ Phoenix.

–í –æ—Ç–ª–∏—á–∏–∏ –æ—Ç Ruby on Rails, —Ñ–µ–Ω–∏–∫—Å –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤–µ–±-—á–∞—Å—Ç–∏. –ò
–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ
–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞.

–£ –Ω–∞—Å –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ —ç–ª–∏–∫—Å–∏—Ä/—Ñ–µ–Ω–∏–∫—Å -- –∫–ª–æ–Ω —Ç–≤–∏—Ç—Ç–µ—Ä–∞. –£ –Ω–∞—Å
—É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–∏–µ —Ñ–∏—á–∏ –∫–∞–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–Ω–∏–µ –∏
–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤, –∏ –Ω–∞—à–∞ –∑–∞–¥–∞—á–∞ -- –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–≤–ª—è—Ç—å
—Ä–µ–ø–ª–∞–∏ –∫ –ø–æ—Å—Ç–∞–º.

** Coding

   –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–ª–∞–µ–≤

*** –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º

–¢.–∫. –≤ —ç–ª–∏–∫—Å–∏—Ä–µ –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ -- –º–æ–¥—É–ª—å.

–í —ç–ª–∏–∫—Å–∏—Ä–µ –∏–º–µ–Ω–∞ –º–æ–¥—É–ª–µ–π –æ—Ç—Ä–∞–∂–∞—é—Ç —Ñ–∞–π–ª–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.

–î–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: `@moduledoc false`

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply.ex" :file-b "b/lib/notatwitter/user/post/reply.ex"
@@ -0,0 +1,3 @@
+defmodule Notatwitter.User.Post.Reply do
+  @moduledoc false
+end

#+END_SRC

–°–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç–∞–∫–æ–µ Ecto.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply.ex" :file-b "b/lib/notatwitter/user/post/reply.ex"
@@ -1,3 +1,6 @@
 defmodule Notatwitter.User.Post.Reply do
   @moduledoc false
+
+  use Ecto.Schema
+
 end

#+END_SRC

–¢–∞–∫ –º—ã —É–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ç–∞–±–ª–∏—Ü—ã, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –Ω–∞—à–∞ —Å—Ö–µ–º–∞.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply.ex" :file-b "b/lib/notatwitter/user/post/reply.ex"
@@ -3,4 +3,6 @@ defmodule Notatwitter.User.Post.Reply do
 
   use Ecto.Schema
 
+  schema "user_post_replies" do
+  end
 end

#+END_SRC

–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ–π –≤ –Ω–∞—à–µ–π —Å—Ö–µ–º–µ.

–£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å —Å—Ö–µ–º–∞ Post –∏ User, –∏ –º—ã —Ö–æ—Ç–∏–º —Å–≤—è–∑–∞—Ç—å –∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Å
–Ω–∞—à–∏–º Reply.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply.ex" :file-b "b/lib/notatwitter/user/post/reply.ex"
@@ -4,5 +4,11 @@ defmodule Notatwitter.User.Post.Reply do
   use Ecto.Schema
 
   schema "user_post_replies" do
+    belongs_to :user, User
+    belongs_to :post, Post
+
+    field :text, :string
+
+    timestamps()
   end
 end

#+END_SRC

–°–Ω–∞—á–∞–ª–∞ –∫–æ–ø–∏–ø–∞—Å—Ç–∏–º Notatwitter.User, –∞ –ø–æ—Ç–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ
–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å alias.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply.ex" :file-b "b/lib/notatwitter/user/post/reply.ex"
@@ -3,6 +3,9 @@ defmodule Notatwitter.User.Post.Reply do
 
   use Ecto.Schema
 
+  alias Notatwitter.User
+  alias Notatwitter.User.Post
+
   schema "user_post_replies" do
     belongs_to :user, User
     belongs_to :post, Post

#+END_SRC

–ú—ã –º–æ–∂–µ–º –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –≤ —Å—Ö–µ–º–µ —Ç–µ–ø–µ—Ä—å:

#+BEGIN_SRC elixir :script mix :session new-session-1
alias Notatwitter.User.Post.Reply
%Reply{}
#+END_SRC

#+RESULTS:
#+begin_example
%Notatwitter.User.Post.Reply{
  __meta__: #Ecto.Schema.Metadata<:built, "user_post_replies">,
  id: nil,
  inserted_at: nil,
  post: #Ecto.Association.NotLoaded<association :post is not loaded>,
  post_id: nil,
  text: nil,
  updated_at: nil,
  user: #Ecto.Association.NotLoaded<association :user is not loaded>,
  user_id: nil
}
#+end_example

#+BEGIN_SRC elixir :script mix :session new-session-1
Reply.__info__(:functions)
#+END_SRC

#+RESULTS:
: [__changeset__: 0, __schema__: 1, __schema__: 2, __struct__: 0, __struct__: 1]

–ù–∞ —ç—Ç–æ–º —Å—Ö–µ–º–∞ –æ–ø–∏—Å–∞–Ω–∞ –∏ –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –æ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫ —Ä–∞–±–æ—Ç–µ
–Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π.

*** –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ö–µ–º–∞–º–∏

–ú—ã –Ω–∞–ø–∏—à–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–∏–∑–Ω–µ—Å–ª–æ–≥–∏–∫–∏ –¥–ª—è –Ω–∞—à–∏—Ö —Ä–µ–ø–ª–∞–µ–≤.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply/manager.ex" :file-b "b/lib/notatwitter/user/post/reply/manager.ex"
@@ -0,0 +1,3 @@
+defmodule Notatwitter.User.Post.Reply.Manager do
+  @moduledoc false
+end

#+END_SRC

–û–ø—Ä–µ–¥–µ–ª–∏–º –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–¥ —Ä–µ–ø–ª–∞—è–º–∏.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply/manager.ex" :file-b "b/lib/notatwitter/user/post/reply/manager.ex"
@@ -1,3 +1,12 @@
 defmodule Notatwitter.User.Post.Reply.Manager do
   @moduledoc false
+
+  def list(post_id) do
+  end
+
+  def create(user_id, post_id, attrs) do
+  end
+
+  def update(reply, attrs) do
+  end
 end

#+END_SRC

–ó–¥–µ—Å—å –Ω–∞–º –ø–æ–º–æ–∂–µ—Ç –æ–¥–∏–Ω –≤–∞–∂–Ω—ã–π –∏–Ω—Å—Ç—É–º–µ–Ω—Ç –∏–∑ Elixir, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –≤–æ
–º–Ω–æ–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, -- –ø–∞–π–ø—ã.

–ü–∞–π–ø -- –æ–ø–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–≤–æ–π –ª–µ–≤—ã–π –æ–ø–µ—Ä–∞–Ω–¥ –ø–µ—Ä–≤—ã–º
–∞—Ä–≥—É–º–µ–Ω—Ç–æ–º –≤ —Ñ—É–Ω–∫—Ü–∏—é, –≤—ã–∑–æ–≤ –∫–æ—Ç–æ—Ä–æ–π —è–≤–ª—è–µ—Ç—Å—è –µ–≥–æ –ø—Ä–∞–≤—ã–º –æ–ø–µ—Ä–∞–Ω–¥–æ–º.

#+BEGIN_SRC elixir
1 |> Kernel.+(2) |> to_string
#+END_SRC

#+RESULTS:
: "3"


–ù–∞—á–Ω—ë–º —Å–æ —Å–ø–∏—Å–∫–∞ -- –∑–¥–µ—Å—å –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è Ecto.Query

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply/manager.ex" :file-b "b/lib/notatwitter/user/post/reply/manager.ex"
@@ -1,7 +1,16 @@
 defmodule Notatwitter.User.Post.Reply.Manager do
   @moduledoc false
 
+  import Ecto.Query
+
+  alias Notatwitter.Repo
+  alias Notatwitter.User.Post.Reply
+
   def list(post_id) do
+    Reply
+    |> where([r], r.post_id == ^post_id)
+    |> preload([:user])
+    |> Repo.all()
   end
 
   def create(user_id, post_id, attrs) do

#+END_SRC

–î–æ–±–∞–≤–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply/manager.ex" :file-b "b/lib/notatwitter/user/post/reply/manager.ex"
@@ -3,6 +3,7 @@ defmodule Notatwitter.User.Post.Reply.Manager do
 
   import Ecto.Query
 
+  alias Ecto.Changeset
   alias Notatwitter.Repo
   alias Notatwitter.User.Post.Reply
 
@@ -14,8 +15,22 @@ defmodule Notatwitter.User.Post.Reply.Manager do
   end
 
   def create(user_id, post_id, attrs) do
+    attrs = Map.merge(attrs, %{"user_id" => user_id, "post_id" => post_id})
+
+    %Reply{}
+    |> Changeset.cast(attrs, [:text, :user_id, :post_id])
+    |> Changeset.foreign_key_constraint(:user_id)
+    |> Changeset.foreign_key_constraint(:post_id)
+    |> Changeset.validate_required([:text, :user_id, :post_id])
+    |> Changeset.validate_length(:text, max: 140, count: :bytes)
+    |> Repo.insert()
   end
 
   def update(reply, attrs) do
+    reply
+    |> Changeset.cast(attrs, [:text])
+    |> Changeset.validate_length(:text, max: 140, count: :bytes)
+    |> Changeset.validate_required([:text, :user_id, :post_id])
+    |> Repo.update()
   end
 end

#+END_SRC

–£ –Ω–∞—Å –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞—à–µ–≥–æ –º–æ–¥—É–ª—è

#+BEGIN_SRC elixir :script mix :session new-session-1
alias Notatwitter.Users
user = Users.list_users() |> hd
#+END_SRC

#+RESULTS:
#+begin_example
[36m[debug] QUERY OK source="users" db=2.9ms queue=0.1ms
SELECT u0."id", u0."username", u0."avatar", u0."inserted_at", u0."updated_at" FROM "users" AS u0 []
[0m %Notatwitter.User{
  __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
  avatar: nil,
  followers: #Ecto.Association.NotLoaded<association :followers is not loaded>,
  follows: #Ecto.Association.NotLoaded<association :follows is not loaded>,
  id: 1,
  inserted_at: ~N[2019-11-10 14:53:17],
  posts: #Ecto.Association.NotLoaded<association :posts is not loaded>,
  updated_at: ~N[2019-11-10 14:53:17],
  username: "test"
}
#+end_example

#+BEGIN_SRC elixir :script mix :session new-session-1
{:ok, post} = Users.create_post(user.id, %{"text" => "post text"})
#+END_SRC

#+RESULTS:
#+begin_example
[32m[debug] QUERY OK db=12.2ms queue=2.7ms
INSERT INTO "user_posts" ("text","user_id","inserted_at","updated_at") VALUES ($1,$2,$3,$4) RETURNING "id" ["post text", 1, ~N[2020-02-24 16:30:54], ~N[2020-02-24 16:30:54]]
[0m [36m[debug] QUERY OK source="users" db=4.5ms queue=0.1ms
SELECT u0."id", u0."username", u0."avatar", u0."inserted_at", u0."updated_at", u0."id" FROM "users" AS u0 WHERE (u0."id" = $1) [1]
[0m {:ok,
 %Notatwitter.User.Post{
   __meta__: #Ecto.Schema.Metadata<:loaded, "user_posts">,
   id: 5,
   inserted_at: ~N[2020-02-24 16:30:54],
   text: "post text",
   updated_at: ~N[2020-02-24 16:30:54],
   user: %Notatwitter.User{
     __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
     avatar: nil,
     followers: #Ecto.Association.NotLoaded<association :followers is not loaded>,
     follows: #Ecto.Association.NotLoaded<association :follows is not loaded>,
     id: 1,
     inserted_at: ~N[2019-11-10 14:53:17],
     posts: #Ecto.Association.NotLoaded<association :posts is not loaded>,
     updated_at: ~N[2019-11-10 14:53:17],
     username: "test"
   },
   user_id: 1
 }}
#+end_example

#+BEGIN_SRC elixir :script mix :session new-session-1
alias Notatwitter.User.Post.Reply.Manager
{:ok, reply} = Manager.create(user.id, post.id, %{"text" => "reply text"})
#+END_SRC

#+RESULTS:
#+begin_example
[32m[debug] QUERY OK db=64.4ms queue=2.1ms
INSERT INTO "user_post_replies" ("post_id","text","user_id","inserted_at","updated_at") VALUES ($1,$2,$3,$4,$5) RETURNING "id" [5, "reply text", 1, ~N[2020-02-24 16:32:03], ~N[2020-02-24 16:32:03]] 
[0m [36m[debug] QUERY OK source="users" db=3.0ms queue=0.1ms
SELECT u0."id", u0."username", u0."avatar", u0."inserted_at", u0."updated_at", u0."id" FROM "users" AS u0 WHERE (u0."id" = $1) [1]
[0m {:ok,
 %Notatwitter.User.Post.Reply{
   __meta__: #Ecto.Schema.Metadata<:loaded, "user_post_replies">,
   id: 6,
   inserted_at: ~N[2020-02-24 16:32:03],
   post: #Ecto.Association.NotLoaded<association :post is not loaded>,
   post_id: 5,
   text: "reply text",
   updated_at: ~N[2020-02-24 16:32:03],
   user: %Notatwitter.User{
     __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
     avatar: nil,
     followers: #Ecto.Association.NotLoaded<association :followers is not loaded>,
     follows: #Ecto.Association.NotLoaded<association :follows is not loaded>,
     id: 1,
     inserted_at: ~N[2019-11-10 14:53:17],
     posts: #Ecto.Association.NotLoaded<association :posts is not loaded>,
     updated_at: ~N[2019-11-10 14:53:17],
     username: "test"
   },
   user_id: 1
 }}
#+end_example

#+BEGIN_SRC elixir :script mix :session new-session-1
{:ok, updated_reply} = Manager.update(reply, %{"text" => "new reply text"})
#+END_SRC

#+RESULTS:
#+begin_example
[33m[debug] QUERY OK db=38.0ms queue=2.5ms
UPDATE "user_post_replies" SET "text" = $1, "updated_at" = $2 WHERE "id" = $3 ["new reply text", ~N[2020-02-24 16:32:50], 6]
[0m {:ok,
 %Notatwitter.User.Post.Reply{
   __meta__: #Ecto.Schema.Metadata<:loaded, "user_post_replies">,
   id: 6,
   inserted_at: ~N[2020-02-24 16:32:03],
   post: #Ecto.Association.NotLoaded<association :post is not loaded>,
   post_id: 5,
   text: "new reply text",
   updated_at: ~N[2020-02-24 16:32:50],
   user: %Notatwitter.User{
     __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
     avatar: nil,
     followers: #Ecto.Association.NotLoaded<association :followers is not loaded>,
     follows: #Ecto.Association.NotLoaded<association :follows is not loaded>,
     id: 1,
     inserted_at: ~N[2019-11-10 14:53:17],
     posts: #Ecto.Association.NotLoaded<association :posts is not loaded>,
     updated_at: ~N[2019-11-10 14:53:17],
     username: "test"
   },
   user_id: 1
 }}
#+end_example

#+BEGIN_SRC elixir :script mix :session new-session-1
Manager.list(post.id)
#+END_SRC

#+RESULTS:
#+begin_example
[36m[debug] QUERY OK source="user_post_replies" db=1.1ms queue=1.3ms
SELECT u0."id", u0."user_id", u0."post_id", u0."text", u0."inserted_at", u0."updated_at" FROM "user_post_replies" AS u0 WHERE (u0."post_id" = $1) [5]
[0m [36m[debug] QUERY OK source="users" db=0.7ms queue=0.1ms
SELECT u0."id", u0."username", u0."avatar", u0."inserted_at", u0."updated_at", u0."id" FROM "users" AS u0 WHERE (u0."id" = $1) [1]
[0m [
  %Notatwitter.User.Post.Reply{
    __meta__: #Ecto.Schema.Metadata<:loaded, "user_post_replies">,
    id: 6,
    inserted_at: ~N[2020-02-24 16:32:03],
    post: #Ecto.Association.NotLoaded<association :post is not loaded>,
    post_id: 5,
    text: "new reply text",
    updated_at: ~N[2020-02-24 16:32:50],
    user: %Notatwitter.User{
      __meta__: #Ecto.Schema.Metadata<:loaded, "users">,
      avatar: nil,
      followers: #Ecto.Association.NotLoaded<association :followers is not loaded>,
      follows: #Ecto.Association.NotLoaded<association :follows is not loaded>,
      id: 1,
      inserted_at: ~N[2019-11-10 14:53:17],
      posts: #Ecto.Association.NotLoaded<association :posts is not loaded>,
      updated_at: ~N[2019-11-10 14:53:17],
      username: "test"
    },
    user_id: 1
  }
]
#+end_example

*** –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –µ—ë
–æ–ø–∏—Å–∞–Ω–∏—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω–æ–º –º–æ–¥—É–ª–µ, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—à–∞ –≤–µ–±-—á–∞—Å—Ç—å –±—É–¥–µ—Ç —Å
–Ω–µ–π —Ä–∞–±–æ—Ç–∞—Ç—å. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º—ã –µ—ë –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ–º.

–î–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –¥–µ–ª–µ–≥–∞—Ç–∞ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ defdelegate,
–∫–æ—Ç–æ—Ä–º—É –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å –∏ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–º –º—ã –¥–µ–ª–µ–≥–∏—Ä—É–µ–º
—Ä–∞–±–æ—Ç—É.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/users.ex" :file-b "b/lib/notatwitter/users.ex"
@@ -3,6 +3,7 @@ defmodule Notatwitter.Users do
 
   alias Notatwitter.{Auth, User}
   alias Notatwitter.User.Post
+  alias Notatwitter.User.Post.Reply
 
   defdelegate list_users(), to: User.Manager, as: :list
   defdelegate find_user(id), to: User.Manager, as: :find
@@ -13,4 +14,13 @@ defmodule Notatwitter.Users do
   defdelegate find_post(post_id), to: Post.Manager, as: :find
   defdelegate create_post(user_id, attrs), to: Post.Manager, as: :create
   defdelegate update_post(post_id, attrs), to: Post.Manager, as: :update
+
+  defdelegate list_replies(post_id), to: Reply.Manager, as: :list
+  defdelegate find_reply(reply_id), to: Reply.Manager, as: :find
+
+  defdelegate create_reply(user_id, post_id, attrs),
+    to: Reply.Manager,
+    as: :create
+
+  defdelegate update_reply(reply_id, attrs), to: Reply.Manager, as: :update
 end

#+END_SRC

*** –†–æ—É—Ç–µ—Ä

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏ —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π, –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º
–∫ –≤–µ–±-—á–∞—Å—Ç–∏. –î–ª—è –Ω–∞—á–∞–ª–∞ –º—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º –≤ —Ä–æ—É—Ç–µ—Ä–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º
–∫–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π.

–§–µ–Ω–∏–∫—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ resources, —á—Ç–æ–±—ã –æ–ø–∏—Å—ã–≤–∞—Ç—å
—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ CRUD-–æ–ø–∏—Ä–∞—Ü–∏–∏ –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–∞–º–∏. –û–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏. –í
–Ω—ë–º –º—ã —É–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—Ç—å –ø—É—Ç–∏ –¥–æ —Ä–µ—Å—É—Ä—Å–∞, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –≤ –∫–æ—Ç–æ—Ä–æ–º —ç—Ç–æ
–¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏ —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π, –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/router.ex" :file-b "b/lib/notatwitter_web/router.ex"
@@ -20,7 +20,11 @@ defmodule NotatwitterWeb.Router do
       get "/posts", PostController, :index
     end
 
-    resources "/posts", PostController, only: [:create, :update]
+    resources "/posts", PostController, only: [:create, :update] do
+      resources "/replies", ReplyController, only: [:index, :create]
+    end
+
+    resources "/replies", ReplyController, only: [:update]
   end
 
   scope "/auth", NotatwitterWeb.Auth do

#+END_SRC

*** –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

–°–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞. –ï–≥–æ –∏–º—è –¥–æ–ª–∂–Ω–æ –æ–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ Controller.

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –Ω–∞–º –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å
NotatwitterWeb —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º :controller.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -0,0 +1,3 @@
+defmodule NotatwitterWeb.ReplyController do
+  @moduledoc false
+end

#+END_SRC

–û–ø—Ä–µ–¥–µ–ª–∏–º –¥–µ–π—Å—Ç–≤–∏—è. –≠—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–µ –¥–≤–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ -- `conn`
–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏, –∞ –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π
–Ω–∞–º –ø–æ–∫–∞ –Ω–µ –≤–∞–∂–µ–Ω -- –≤—Å–µ–≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (json body,
form-data, query –∏ –≤–æ—Ç —ç—Ç–æ –≤—Å—ë).

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -1,3 +1,14 @@
 defmodule NotatwitterWeb.ReplyController do
   @moduledoc false
+
+  use NotatwitterWeb, :controller
+
+  def index(conn, _) do
+  end
+
+  def create(conn, _) do
+  end
+
+  def update(conn, _) do
+  end
 end

#+END_SRC

–†–µ—Å—É—Ä—Å—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –Ω–∞–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–∂–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤–æ –≤—Ç–æ—Ä–æ–π
–∞—Ä–≥—É–º–µ–Ω—Ç. –ú—ã –∏–∑–≤–ª–µ—á—ë–º –∏—Ö –ø—Ä—è–º–æ –æ—Ç—Ç—É–¥–∞.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -3,12 +3,12 @@ defmodule NotatwitterWeb.ReplyController do
 
   use NotatwitterWeb, :controller
 
-  def index(conn, _) do
+  def index(conn, %{"post_id" => post_id}) do
   end
 
-  def create(conn, _) do
+  def create(conn, %{"post_id" => post_id} = params) do
   end
 
-  def update(conn, _) do
+  def update(conn, %{"id" => id} = params) do
   end
 end

#+END_SRC

–í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –º—ã –±—É–¥–µ–º –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞—à—É –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –∏, –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã–ª–æ
–∑–∞–º–µ—Ç–∏—Ç—å, —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ id –ø–æ—Å—Ç–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω
—Ä–µ–ø–ª–∞–π, –Ω–æ –∏ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ–≥–æ —Å–¥–µ–ª–∞–≤—à–µ–≥–æ. –î–ª—è –µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –º—ã
–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é current_resource –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Guardian, –∫–æ—Ç–æ—Ä–∞—è
–æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ú—ã –µ–π
–ø–µ—Ä–µ–¥–∞—ë–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω–Ω–µ–∫—à–æ–Ω–∞ –∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -7,6 +7,7 @@ defmodule NotatwitterWeb.ReplyController do
   end
 
   def create(conn, %{"post_id" => post_id} = params) do
+    %{id: user_id} = Guardian.Plug.current_resource(conn)
   end
 
   def update(conn, %{"id" => id} = params) do

#+END_SRC

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É –Ω–∞—Å –µ—Å—Ç—å, –º—ã –º–æ–∂–µ–º
–ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –≤—ã–∑–æ–≤—É —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—ë–º
–≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤—å—é—à–∫–∏.

- [ ] –ù–µ–±–æ–ª—å—à–æ–π –∏–Ω—Ç—Ä–æ–¥–∞–∫—à–æ–Ω –≤ with

–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–≤–∞ –¥–µ–π—Å—Ç–≤–∏—è: –Ω–∞–π—Ç–∏ –ø–æ—Å—Ç –ø–æ id –∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è
—Å–æ–∑–¥–∞—Ç—å –∫ —ç—Ç–æ–º—É –ø–æ—Å—Ç—É —Ä–µ–ø–ª–∞–π. –ö–∞–∂–¥–æ–µ –∏–∑ —ç—Ç–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å
–æ—à–∏–±–∫—É, –∏ –Ω–∞–º –Ω–∞–¥–æ –≤–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–≤—É—é –æ—à–∏–±–∫—É, —Å –∫–æ—Ç–æ—Ä–æ–π –º—ã —Å—Ç–æ–ª–∫–Ω—ë–º—Å—è. –í
—ç—Ç–æ–º –Ω–∞–º –ø–æ–º–æ–∂–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫–∏—è with.

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ —Ä–µ–ø–ª–∞–π —É–∂–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω. –¢.–∫. –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º—ã –¥–æ–ª–∂–Ω—ã
–≤–µ—Ä–Ω—É—Ç—å 201, –º—ã –≤—ã–∑—ã–≤–∞–µ–º –Ω–∞ conn —Ñ—É–Ω–∫—Ü–∏—é put_status, –∫–æ—Ç–æ—Ä–∞—è
—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –º–æ–∂–µ–º –≤—ã–∑—ã–≤–∞—Ç—å render.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -3,13 +3,27 @@ defmodule NotatwitterWeb.ReplyController do
 
   use NotatwitterWeb, :controller
 
+  alias Notatwitter.Users
+
   def index(conn, %{"post_id" => post_id}) do
+    replies = Users.list_replies(post_id)
+    render(conn, "index.json", replies: replies)
   end
 
   def create(conn, %{"post_id" => post_id} = params) do
     %{id: user_id} = Guardian.Plug.current_resource(conn)
+
+    with {:ok, reply} <- Users.create_reply(user_id, post_id, params) do
+      conn
+      |> put_status(:created)
+      |> render("created.json", reply: reply)
+    end
   end
 
   def update(conn, %{"id" => id} = params) do
+    with {:ok, reply} <- Users.find_reply(id),
+         {:ok, reply} <- Users.update_reply(reply, params) do
+      render(conn, "updated.json", reply: reply)
+    end
   end
 end

#+END_SRC

–ö–∞–∫ –º—ã –º–æ–∂–µ–º —É–≤–∏–¥–µ—Ç—å, –º—ã –Ω–∏–∫–∞–∫ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
-- –∞ –≤–µ–¥—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç —Å–æ–≤–µ—Ä—à–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä
—Ä–µ–ø–ª–∞—è. –ß—Ç–æ–±—ã —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É
Bodyguard. –ù–∞–º –Ω–∞–¥–æ –ø–µ—Ä–µ–¥–∞—Ç—å –º–æ–¥—É–ª—å, –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø—Ä–∞–≤–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ
–¥–µ–π—Å—Ç–≤–∏—è, —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–∞–º –æ–±—ä–µ–∫—Ç, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º —Å–æ–≤–µ—Ä—à–∞–µ—Ç—Å—è
–¥–µ–π—Å—Ç–≤–∏–µ.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -3,6 +3,7 @@ defmodule NotatwitterWeb.ReplyController do
 
   use NotatwitterWeb, :controller
 
+  alias Notatwitter.User.AccessPolicy
   alias Notatwitter.Users
 
   def index(conn, %{"post_id" => post_id}) do
@@ -21,7 +22,11 @@ defmodule NotatwitterWeb.ReplyController do
   end
 
   def update(conn, %{"id" => id} = params) do
+    current_user = Guardian.Plug.current_resource(conn)
+
     with {:ok, reply} <- Users.find_reply(id),
+         :ok <-
+           Bodyguard.permit(AccessPolicy, :update_reply, current_user, reply),
          {:ok, reply} <- Users.update_reply(reply, params) do
       render(conn, "updated.json", reply: reply)
     end

#+END_SRC

–¢–µ–ø–µ—Ä—å –Ω–∞–¥–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –º–æ–¥—É–ª—è —Å –ø—Ä–∞–≤–∞–º–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
–¥–ª—è –Ω–∞—à–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/access_policy.ex" :file-b "b/lib/notatwitter/user/access_policy.ex"
@@ -18,6 +18,11 @@ defmodule Notatwitter.User.AccessPolicy do
     :ok
   end
 
+  @impl true
+  def authorize(:update_reply, %{id: id}, %{user_id: id}) do
+    :ok
+  end
+
   @impl true
   def authorize(_, _, _) do
     :error

#+END_SRC

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É %Plug.Conn{},
–Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ–π—á–∞—Å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç error-—Ç—É–ø–ª –Ω–∞ –æ—à–∏–±–∫–µ. –≠—Ç–æ
—Å–¥–µ–ª–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–µ–π—Å—ã –∏ –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å
—Å–æ—Ç–Ω–∏ —Ä–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫. –ú—ã –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å fallback controller,
–∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–µ –Ω–µ-conn –∑–Ω–∞—á–µ–Ω–∏—è.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/controllers/reply_controller.ex" :file-b "b/lib/notatwitter_web/controllers/reply_controller.ex"
@@ -6,6 +6,8 @@ defmodule NotatwitterWeb.ReplyController do
   alias Notatwitter.User.AccessPolicy
   alias Notatwitter.Users
 
+  action_fallback NotatwitterWeb.ErrorController
+
   def index(conn, %{"post_id" => post_id}) do
     replies = Users.list_replies(post_id)
     render(conn, "index.json", replies: replies)

#+END_SRC

–ù–∞ —ç—Ç–æ–º —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏ –≤—Å—ë, –∏ –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫–æ –≤—å—é.

*** –í—å—é

–ö–∞–∫ –≤—Å–µ–≥–¥–∞, –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å. –ú–æ–¥—É–ª–∏ –≤—å—é –∏–º–µ—é—Ç —Ç–∞–∫–æ–µ –∂–µ –∏–º—è,
—á—Ç–æ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–º –º–æ–¥—É–ª—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, –Ω–æ —Å –∑–∞–º–µ–Ω–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è
Controller –Ω–∞ View.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/views/reply_view.ex" :file-b "b/lib/notatwitter_web/views/reply_view.ex"
@@ -0,0 +1,3 @@
+defmodule NotatwitterWeb.ReplyView do
+  @moduledoc false
+end

#+END_SRC

–î–µ–π—Å—Ç–≤–∏—è –≤–æ –≤—å—é –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω-–º–∞—Ç—á–∏–Ω–≥–æ–º –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–µ
—Ñ—É–Ω–∫—Ü–∏–∏ `render/2`. –ú—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π, –∞ —Ç–∞–∫ –∂–µ
–æ–±—â–∏–π `render/2`, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å —Ä–µ–ø–ª–∞–π.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/views/reply_view.ex" :file-b "b/lib/notatwitter_web/views/reply_view.ex"
@@ -1,3 +1,17 @@
 defmodule NotatwitterWeb.ReplyView do
   @moduledoc false
+
+  use NotatwitterWeb, :view
+
+  def render("index.json", %{replies: replies}) do
+  end
+
+  def render("created.json", %{reply: reply}) do
+  end
+
+  def render("updated.json", %{reply: reply}) do
+  end
+
+  def render("reply.json", %{reply: %{user: user} = reply}) do
+  end
 end

#+END_SRC

–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–µ–º –æ–±—â—É—é –≤—å—é—Ö—É. –í –Ω–µ–π –º—ã –±—É–¥–µ–º –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –º–∞–ø—É —Å –ø–æ–ª—è–º–∏
-- –æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ç—Å—è –≤ json –Ω–∞—à–∏–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–º.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/views/reply_view.ex" :file-b "b/lib/notatwitter_web/views/reply_view.ex"
@@ -13,5 +13,13 @@ defmodule NotatwitterWeb.ReplyView do
   end
 
   def render("reply.json", %{reply: %{user: user} = reply}) do
+    %{
+      id: reply.id,
+      user_id: user.id,
+      username: user.username,
+      avatar: image_url({user.avatar, user}, :big),
+      created_at: datetime_to_integer(reply.inserted_at),
+      text: reply.text
+    }
   end
 end

#+END_SRC

–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω–∞–¥–æ —Ç–æ–ª—å–∫–æ –≤—ã–∑–≤–∞—Ç—å —ç—Ç—É –≤—å—é—Ö—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—å—é—Ö–∞—Ö –Ω–∞ –∫–∞–∂–¥–æ–µ
–¥–µ–π—Å—Ç–≤–∏–µ.

–î–ª—è "created.json" –∏ "updated.json" –º—ã –±—É–¥–µ–º –≤—ã–∑—ã–≤–∞—Ç—å –µ—ë —á–µ—Ä–µ–∑
`render_one/4` -- –æ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é –≤—å—é—Ö—É –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç —Ç—É–¥–∞
–ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/views/reply_view.ex" :file-b "b/lib/notatwitter_web/views/reply_view.ex"
@@ -7,9 +7,11 @@ defmodule NotatwitterWeb.ReplyView do
   end
 
   def render("created.json", %{reply: reply}) do
+    render_one(reply, __MODULE__, "reply.json")
   end
 
   def render("updated.json", %{reply: reply}) do
+    render_one(reply, __MODULE__, "reply.json")
   end
 
   def render("reply.json", %{reply: %{user: user} = reply}) do

#+END_SRC

–í —Å–ª—É—á–∞–µ —Å "index.json" –º—ã –∏–º–µ–µ–º –¥–µ–ª–æ –Ω–µ —Å –æ–¥–Ω–∏–º —Ä–µ–ø–ª–∞–µ–º, –∞ —Å–æ
—Å–ø–∏—Å–∫–æ–º. –° –Ω–∏–º–∏ –Ω–∞–º –ø–æ–º–æ–∂–µ—Ç `render_many/4`.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter_web/views/reply_view.ex" :file-b "b/lib/notatwitter_web/views/reply_view.ex"
@@ -4,6 +4,7 @@ defmodule NotatwitterWeb.ReplyView do
   use NotatwitterWeb, :view
 
   def render("index.json", %{replies: replies}) do
+    render_many(replies, __MODULE__, "reply.json")
   end
 
   def render("created.json", %{reply: reply}) do

#+END_SRC

–ù–∞ —ç—Ç–æ–º —Å–æ –≤—å—é—Ö–∞–º–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏.

*** –ó–∞–ø—É—Å–∫–∞–µ–º

–î–ª—è —Ç–µ—Å—Ç–∞ –º—ã –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è —Ä–µ—Å—Ç-–∫–ª–∏–µ–Ω—Ç–æ–º –¥–ª—è –∏–º–∞–∫—Å–∞.

#+BEGIN_SRC sh :dir "." :results output :exports both :eval yes
mix phx.server
#+END_SRC

#+BEGIN_SRC restclient
POST http://localhost:4000/auth/register
Accept: application/json
Content-Type: application/json

{"username":"username","password":"password"}
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "id": 6,
  "username": "username"
}
// POST http://localhost:4000/auth/register
// HTTP/1.1 201 Created
// cache-control: max-age=0, private, must-revalidate
// content-length: 30
// content-type: application/json; charset=utf-8
// cross-origin-window-policy: deny
// date: Mon, 24 Feb 2020 16:11:15 GMT
// server: Cowboy
// x-content-type-options: nosniff
// x-download-options: noopen
// x-frame-options: SAMEORIGIN
// x-permitted-cross-domain-policies: none
// x-request-id: FfZijCQGM5eG9rgAAAEE
// x-xss-protection: 1; mode=block
// Request duration: 2.221744s
#+END_SRC

#+BEGIN_SRC restclient
POST http://localhost:4000/auth/login
Accept: application/json
Content-Type: application/json

{"username":"username","password":"password"}
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "id": 6,
  "token": "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJub3RhdHdpdHRlciIsImV4cCI6MTU4NDk3OTk1NywiaWF0IjoxNTgyNTYwNzU3LCJpc3MiOiJub3RhdHdpdHRlciIsImp0aSI6IjAwMjBkZjdhLTI4MzgtNDlkYy05OTQzLWY5OGY0NWE4ZmVlNCIsIm5iZiI6MTU4MjU2MDc1Niwic3ViIjoiNiIsInR5cCI6ImFjY2VzcyJ9.hKEShyjLV2VVMdxE-hLZ3B61GnkqNtzjyjDFtb-0VkIP8xcG2u-rOtKRnvyCSRdHrzIzlf5aBQUQpDFnBMfehw",
  "username": "username"
}
// POST http://localhost:4000/auth/login
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 381
// content-type: application/json; charset=utf-8
// cross-origin-window-policy: deny
// date: Mon, 24 Feb 2020 16:12:37 GMT
// server: Cowboy
// x-content-type-options: nosniff
// x-download-options: noopen
// x-frame-options: SAMEORIGIN
// x-permitted-cross-domain-policies: none
// x-request-id: FfZin3qbOBUYl5YAAAEk
// x-xss-protection: 1; mode=block
// set-cookie: sessionToken=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJub3RhdHdpdHRlciIsImV4cCI6MTU4NDk3OTk1NywiaWF0IjoxNTgyNTYwNzU3LCJpc3MiOiJub3RhdHdpdHRlciIsImp0aSI6IjAwMjBkZjdhLTI4MzgtNDlkYy05OTQzLWY5OGY0NWE4ZmVlNCIsIm5iZiI6MTU4MjU2MDc1Niwic3ViIjoiNiIsInR5cCI6ImFjY2VzcyJ9.hKEShyjLV2VVMdxE-hLZ3B61GnkqNtzjyjDFtb-0VkIP8xcG2u-rOtKRnvyCSRdHrzIzlf5aBQUQpDFnBMfehw; Path=/; Max-Age=86400
// Request duration: 1.846802s
#+END_SRC

#+BEGIN_SRC restclient
POST http://localhost:4000/posts
Accept: application/json
Content-Type: application/json

{"text":"new post!"}
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "avatar": null,
  "createdAt": 1582560864,
  "id": 3,
  "text": "new post!",
  "userId": 6,
  "username": "username"
}
// POST http://localhost:4000/posts
// HTTP/1.1 201 Created
// cache-control: max-age=0, private, must-revalidate
// content-length: 97
// content-type: application/json; charset=utf-8
// cross-origin-window-policy: deny
// date: Mon, 24 Feb 2020 16:14:24 GMT
// server: Cowboy
// x-content-type-options: nosniff
// x-download-options: noopen
// x-frame-options: SAMEORIGIN
// x-permitted-cross-domain-policies: none
// x-request-id: FfZiuJ0CMGRgKm4AAAGE
// x-xss-protection: 1; mode=block
// set-cookie: sessionToken=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJub3RhdHdpdHRlciIsImV4cCI6MTU4NDk3OTk1NywiaWF0IjoxNTgyNTYwNzU3LCJpc3MiOiJub3RhdHdpdHRlciIsImp0aSI6IjAwMjBkZjdhLTI4MzgtNDlkYy05OTQzLWY5OGY0NWE4ZmVlNCIsIm5iZiI6MTU4MjU2MDc1Niwic3ViIjoiNiIsInR5cCI6ImFjY2VzcyJ9.hKEShyjLV2VVMdxE-hLZ3B61GnkqNtzjyjDFtb-0VkIP8xcG2u-rOtKRnvyCSRdHrzIzlf5aBQUQpDFnBMfehw; Path=/; Max-Age=86400
// Request duration: 0.319683s
#+END_SRC

#+BEGIN_SRC restclient
POST http://localhost:4000/posts/3/replies
Accept: application/json
Content-Type: application/json

{"text":"reply!"}
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
{
  "avatar": null,
  "createdAt": 1582560956,
  "id": 5,
  "text": "reply!",
  "userId": 6,
  "username": "username"
}
// POST http://localhost:4000/posts/3/replies
// HTTP/1.1 201 Created
// cache-control: max-age=0, private, must-revalidate
// content-length: 94
// content-type: application/json; charset=utf-8
// cross-origin-window-policy: deny
// date: Mon, 24 Feb 2020 16:15:56 GMT
// server: Cowboy
// x-content-type-options: nosniff
// x-download-options: noopen
// x-frame-options: SAMEORIGIN
// x-permitted-cross-domain-policies: none
// x-request-id: FfZizifZc9S8BfwAAAHk
// x-xss-protection: 1; mode=block
// set-cookie: sessionToken=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJub3RhdHdpdHRlciIsImV4cCI6MTU4NDk3OTk1NywiaWF0IjoxNTgyNTYwNzU3LCJpc3MiOiJub3RhdHdpdHRlciIsImp0aSI6IjAwMjBkZjdhLTI4MzgtNDlkYy05OTQzLWY5OGY0NWE4ZmVlNCIsIm5iZiI6MTU4MjU2MDc1Niwic3ViIjoiNiIsInR5cCI6ImFjY2VzcyJ9.hKEShyjLV2VVMdxE-hLZ3B61GnkqNtzjyjDFtb-0VkIP8xcG2u-rOtKRnvyCSRdHrzIzlf5aBQUQpDFnBMfehw; Path=/; Max-Age=86400
// Request duration: 0.169850s
#+END_SRC

#+BEGIN_SRC restclient
GET http://localhost:4000/posts/3/replies
Accept: application/json
Content-Type: application/json
#+END_SRC

#+RESULTS:
#+BEGIN_SRC js
[
  {
    "avatar": null,
    "createdAt": 1582560956,
    "id": 5,
    "text": "reply!",
    "userId": 6,
    "username": "username"
  }
]
// GET http://localhost:4000/posts/3/replies
// HTTP/1.1 200 OK
// cache-control: max-age=0, private, must-revalidate
// content-length: 96
// content-type: application/json; charset=utf-8
// cross-origin-window-policy: deny
// date: Mon, 24 Feb 2020 16:17:01 GMT
// server: Cowboy
// x-content-type-options: nosniff
// x-download-options: noopen
// x-frame-options: SAMEORIGIN
// x-permitted-cross-domain-policies: none
// x-request-id: FfZi3Wk3yE2b6sgAAAMB
// x-xss-protection: 1; mode=block
// set-cookie: sessionToken=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJub3RhdHdpdHRlciIsImV4cCI6MTU4NDk3OTk1NywiaWF0IjoxNTgyNTYwNzU3LCJpc3MiOiJub3RhdHdpdHRlciIsImp0aSI6IjAwMjBkZjdhLTI4MzgtNDlkYy05OTQzLWY5OGY0NWE4ZmVlNCIsIm5iZiI6MTU4MjU2MDc1Niwic3ViIjoiNiIsInR5cCI6ImFjY2VzcyJ9.hKEShyjLV2VVMdxE-hLZ3B61GnkqNtzjyjDFtb-0VkIP8xcG2u-rOtKRnvyCSRdHrzIzlf5aBQUQpDFnBMfehw; Path=/; Max-Age=86400
// Request duration: 0.153013s
#+END_SRC

–ú—ã –≤–æ –≤—å—é—à–∫–µ —Ö–æ—Ç–∏–º –∏–º–µ—Ç—å username –∏ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Å–≤—è–∑–∞–Ω —Å
—Ä–µ–ø–ª–∞–µ–º. –ü–æ—ç—Ç–æ–º—É –Ω–∞–º –Ω—É–∂–Ω–æ –∏—Ö –¥–æ—Å—Ç–∞—Ç—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –î–ª—è —ç—Ç–æ–≥–æ –º—ã
–≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è Repo.preload.

–ú—ã –≤—ã–Ω–µ—Å–µ–º –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –≤ with
—É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–ª—Å—è, –∏ –≤ —Ç–µ–ª–µ –≤—ã–∑–æ–≤–µ–º Repo.preload.

–¢–∞–∫ –∂–µ, –ø—Ä–µ–ª–æ–∞–¥ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é list.

#+BEGIN_SRC diff :file-a "a/lib/notatwitter/user/post/reply/manager.ex" :file-b "b/lib/notatwitter/user/post/reply/manager.ex"
@@ -15,6 +15,12 @@ defmodule Notatwitter.User.Post.Reply.Manager do
   end
 
   def create(user_id, post_id, attrs) do
+    with {:ok, reply} <- do_create(user_id, post_id, attrs) do
+      {:ok, Repo.preload(reply, [:user])}
+    end
+  end
+
+  defp do_create(user_id, post_id, attrs) do
     attrs = Map.merge(attrs, %{"user_id" => user_id, "post_id" => post_id})
 
     %Reply{}
@@ -26,7 +32,13 @@ defmodule Notatwitter.User.Post.Reply.Manager do
     |> Repo.insert()
   end
 
-  def update(reply, attrs) do
+  def update(%Reply{} = reply, attrs) do
+    with {:ok, reply} <- do_update(reply, attrs) do
+      {:ok, Repo.preload(reply, [:user])}
+    end
+  end
+
+  defp do_update(reply, attrs) do
     reply
     |> Changeset.cast(attrs, [:text])
     |> Changeset.validate_length(:text, max: 140, count: :bytes)

#+END_SRC

–¢–µ–ø–µ—Ä—å –≤—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å.
